---
title: "Stable Isotope Mixing Models in R with simmr"
author: "Andrew Parnell and Richard Inger"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
     toc: true
vignette: >
  %\VignetteIndexEntry{simmr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

## Introduction

tl;dr see the [Quick Start](https://cran.r-project.org/package=simmr/vignettes/quick_start.html) vignette

`simmr` is a package designed to solve mixing equations for stable isotopic data within a Bayesian framework. This guide is designed to get researchers up and running with the package and giving them a full list of all the available features. No expertise is required in the use of R. 

`simmr` is designed as an upgrade to the [SIAR](https://CRAN.R-project.org/package=siar) package and contains many of the same features. This new version contains a slightly more sophisticated mixing model, a simpler user interface, and more advanced plotting features. The key differences between SIAR and `simmr` are:

  - `simmr` has a slightly richer mixing model based on code from the Parnell et al 2013 Environmetrics paper
  - `simmr` does not have a menu system; all commands must be run through the console or script windows
  - `simmr` uses ggplot2 to create graphs and JAGS to run the mixing model

We assume that you have a sound working knowledge of stable isotopic mixing models, and the assumptions and potential pitfalls associated with these models. A list of required reading is presented in Appendix A of this guide. We strongly recommend reading Philips et al 2015, Canadian Journal of Zoology for the basic assumptions and do's and don'ts of running mixing models.

We assume that if you have got this far you have [installed R](https://www.r-project.org). We also recommend installing [Rstudio](https://www.rstudio.com) as this provides a very neat interface to use R and `simmr`. The instructions below all assume you are using Rstudio. To get `simmr` running you will also need to have [installed JAGS](http://sourceforge.net/projects/mcmc-jags/files/).

If you find bugs in the software, or wish to suggest new features, please add your input to the `simmr` [GitHub page](https://github.com/andrewcparnell/simmr/issues).

## Installation of the `simmr` package

The `simmr` package uses the JAGS (Just Another Gibbs Sampler) programmer to run the stable isotope mixing model. Before you install simmr, visit the [JAGS](http://mcmc-jags.sourceforge.net) website and download and install JAGS for your operating system. 

Next, start Rstudio and find the window with the command prompt (the symbol `>`). Type

```{r,eval=FALSE}
install.packages('simmr')
```
It may ask you to pick your nearest CRAN mirror (the nearest site which hosts R packages). You will then see some activity on the screen as the `simmr` package and the other packages it uses are downloaded. The final line should then read: 

`package 'simmr' successfully unpacked and MD5 sums checked`

You then need to load the package. This vignette (and lots of the examples), also use `dplyr` so you should install that too. Type

```{r, results = 'hide'}
library(simmr)
library(dplyr)
```

This will load the `simmr` package and all the associated packages. You’ll need to type the `library(simmr)` command every time you start R. If you haven't installed JAGS properly you will be informed at this point. 

## Considerations before running simmr

Before getting started there are a couple of points to consider.

### Working with scripts
The best way to use the `simmr` package is by creating scripts. A script can be created in Rstudio by clicking `File > New File > Rscript`. This opens a text window which allows commands to be typed in order and saved. The command can be sent to the command prompt (which Rstudio calls the Console) by highlighting the command and clicking Run (or going to Code > Run Lines). There are also keyboard shortcuts to speed up the process. We strongly recommend you learn to run R via scripts.

### Data Structure
`simmr` can handle three different types of data structure:

- A single consumer. This may occur when you have only one data point on a single individual
- Multiple consumers. This may occur if you have multiple individuals in a single sampling period
- Multiple groups of consumers. This may occur if you have multiple consumers which are observed over different sampling periods/locations, different demographic groups, etc.

Unless you specify a grouping variable `simmr` assumes that all the observations are from the same group. If you have extra variables (e.g. explanatory variables) that you think may influence the dietary proportions, you should consider using (MixSIAR)[https://github.com/brianstock/MixSIAR] instead.

## Structure of the input files

The general structure for running `simmr` is as follows:

1. Call `simmr_load` on the data to get it into the right format
2. Plot the data in isotope space ('iso-space') using `plot`
3. Run the mixing model with `simmr_mcmc`
4. Explore the results with `plot` and `summary`

For the next part of this document, we concentrate on simple examples without grouping structure. 

### Step 1: Getting the data into simmr

`simmr` requires at minimum 3 input objects; the consumers or _mixtures_, the _source means_, and the _source standard deviations_. Optionally, you can also add correction data (also called trophic enrichment factors, TEFs) represented again as means and standard deviations, and concentration dependence values. I would suggest one of two ways to get data into `simmr`. The first is recommended for people who are new to R (and especially to R's data structures), whilst the second is recommended for those who can work with data frames and lists. They are:

<!-- 1. Put your data into an Excel spreadsheet and load in the data using the `readxl` package. A method for doing this is described in detail in the [quick_start](https://cran.r-project.org/package=simmr/vignettes/quick_start.html) vignette. -->
1. Load your data into R (using the standard R tools) and then create a list which conforms to that expected by the `simmr_load` function. 

This document will follow the second method. Those unfamiliar how to load and manipulate lists are strongly recommended to follow the [quick start](https://cran.r-project.org/package=simmr/vignettes/quick_start.html) guide instead (and to learn some more R!).

We will use some of the data files that come with simmr

```{r}
data("geese_data_day1")
str(geese_data_day1)
```

The structure `simmr_data_1` is a list with a number of necessary and optional named elements. They are:

- The `mixtures` element contains the stable isotopic data for the consumers. The data should be a matrix or data frame with the consumer values in the rows and the columns specifying the two tracers. Any number of isotopes and observations can be used. 
- The source names are provided in the `source_names` element
- The tracer names are provided in the `tracer_names` element (optional)
- The source means and standard deviations in `source_means` and `source_sds`. These latter elements must also be matrices or data frames, where the number of rows is the number of sources, and the number of columns the number of isotopes. In each case, the data are included by listing the values for the first isotope, then the second isotope, and so on. They must be in the same order as the `mixtures` element, and as specified in the `tracer_names` element
- The correction data (sometimes referred to as trophic enrichment or discrimination factors) are stored in `correction_means` and `correction_sds`. Again this should be a matrix or data frame of the same dimension as `s_means` and `s_sds`.
- Finally the concentration dependencies (i.e. the elemental concentration values) are included as `concentration_means`.

Note that the `correction_means`, the `correction_sds`, and the `concentration_means` are all optional.

To load the data into simmr, use:

```{r,include=FALSE}
library(simmr)
```
```{r, results = 'hide'}
simmr_in = geese_data_day1 %>% simmr_load
```

This will load the data into simmr, produce an iso-space plot, and provide a textual description of the object loaded.

### Step 2: Plotting the data in iso-space

If the iso-space plot is required again (or changes are required), it can be re-created with

```{r,fig.align='center',fig.width=7,fig.height=5}
simmr_in %>% plot
```

This will produce a biplot with the isotope that is in the first column on the x-axis, and the isotope in the second column on the y-axis. You can make the plot slightly nicer with some extra arguments:

```{r,fig.align='center',fig.width=7,fig.height=5}
simmr_in %>% plot(xlab=expression(paste(delta^13, "C (\u2030)",sep="")), 
                  ylab=expression(paste(delta^15, "N (\u2030)",sep="")), 
                  title='Isospace plot of Geese data',
                  mix_name = 'Geese - day 1')
```

See the help file ```help(plot.simmr_input)``` for more options on the plotting commands, including the ability to plot different tracers/isotopes when there are more than 2 isotopes.

If all the mixtures lie inside the mixing polygon defined by the sources, then the data are acceptable for running `simmr`. See Philips et al 2015, Canadian Journal of Zoology for more details on when data are suitable for running through a mixing model.

### Step 3: running simmr

The next step is to actually run the model. This is achieved with the command:

```{r,results='hide'}
simmr_out = simmr_in %>% simmr_mcmc
```

This command takes the object `simmr_in` we created earlier and uses it as input for the model. It tells `simmr` to store the output from the model run in an object called `simmr_out`.

The model should take less than a minute to run, though this will depend on the speed of the computer you are using. Other data sets might take slightly longer or shorter depending on the number of sources, isotopes, and observations. The progress of the model is displayed on the command line window, which shows the percentage complete. 

## Checking the model

Markov chain Monte Carlo (MCMC) works by repeatedly guessing the values of the dietary proportions and find those values which fit the data best. The initial guesses are usually poor and are discarded as part of an initial phase known as the burn-in. Subsequent iterations are then stored and used for the _posterior distribution_; the best estimates of the dietary proportions given the data and the model. Because it can take many thousands of iterations to move away from the initial guesses, _convergence diagnostics_ can be created to check the model has run properly. In `simmr` this is done with:

```{r}
simmr_out %>% summary(type='diagnostics')
```

If the model run has converged properly the values should be close to 1. If they are above 1.1, we recommend a longer run. See `help(simmr_mcmc)` for how to do this. 

You can check the fit of the model with a posterior predictive check. This is similar to a fitted values plot in a linear regression. If the data points (denoted by the plot as $y$) broadly lie in the fitted value intervals (denoted $y_rep$; the default is a 50% interval) then the model is fitting well:

```{r,results='hide'}
simmr_out %>% posterior_predictive
```

### Step 4: exploring the results

All SIMMs use informative (usually generalist) prior distributions as a default. You can plot the priors and the posteriors with:

```{r,results='hide'}
simmr_out %>% prior_viz
```

`simmr` produces both textual and graphical summaries of the model run. Starting with the textual summaries, we can get tables of the means, standard deviations and credible intervals (the Bayesian equivalent of a confidence interval) with:

```{r}
simmr_out %>% summary(type='statistics')
simmr_out %>% summary(type='quantiles')
```

These suggest that the dietary proportions for this model are quite uncertain. However we can see that the credible interval for Zostera is the highest, running from approximately 55% to 68% of the diet. However Grass is that one that is most precisely estimated. The reason this one is the narrowest can be seen from the isospace plot - this source is the most clearly separated from the others.

`simmr` can also produce histograms, boxplots, density plots, and matrix plots of the output. Starting with the density plot:

```{r,fig.align='center',fig.width=7,fig.height=5}
simmr_out %>% plot(type='density')
```

We can see that U.lactuca. and Enteromorpha are poorly constrained in comparison to Zostera and especially Grass. Again this is unsurprising since the isospace plot indicated that these were the two most clearly separated sources.

The most useful output plot is the matrix plot:

```{r,fig.align='center',fig.width=7, fig.height=5}
simmr_out %>% plot(type='matrix')
```

This shows the source histograms on the diagonal, contour plots of the relationship between the sources on the upper diagonal, and the correlation between the sources on the lower diagonal. Large negative correlations indicate that the model cannot discern between the two sources; they may lie close together in iso-space. Large positive correlations are also possible when mixture data lie in a polygon consisting of multiple competing sources. Here the largest negative correlation is between Zostera and Enteromorpha. This is because they lie closest together in isospace. In general, high correlations (negative or positive) are indicative of the model being unable to determine which food sources are being consumed, and are an unavoidable part of stable isotope mixing models.

If you want to compare the dietary proportions between two different sources, you can use the `compare_sources` function. This takes two or more sources and compares the dietary proportions with an optional plot. For example:

```{r,fig.align='center',fig.width=7, fig.height=5}
simmr_out %>% compare_sources(source_names=c('Zostera','U.lactuca'))
```

This produces a direct probability that the dietary proportion for the first source is bigger than that of the second. If you want to compare more than two sources, specify them with:

```{r,fig.align='center',fig.width=7, fig.height=5}
simmr_out %>% compare_sources(source_names=c('Zostera','U.lactuca','Enteromorpha'))
```

For further information and options on comparing sources, see `help(compare_sources)`.

## Combining sources

A common request is that of combining sources. We would recommend always doing this *after* running `simmr`, known as _a-posteriori_ combining. Suppose for example, you wish to combine the U.lactuca and Enteromorpha sources which lie in a similar region in the isospace plot of the Geese data. To proceed, we can create a new `simmr` object using the `combine_sources` function:

```{r,fig.align='center',fig.width=7, fig.height=5}
simmr_out_combine = simmr_out %>% combine_sources(to_combine = c('U.lactuca','Enteromorpha'),
                                                  new_source_name='U.lac+Ent')
simmr_out_combine %>% plot(type = 'isospace')
simmr_out_combine %>% plot(type='boxplot',title='simmr output: combined sources')
```

## Running simmr with only one isotope

`simmr` will run fine with only one tracer, and no changes should be required to any of the functions. Here is an artificial example with only one isotope created by dropping the Nitrogen isotope from the geese data:

```{r}
data('geese_data_day1')
geese_data_1iso = geese_data_day1
geese_data_1iso$mixtures = geese_data_day1$mixtures[,1]
geese_data_1iso$source_means = geese_data_day1$source_means[,1]
geese_data_1iso$source_sds = geese_data_day1$source_sds[,1]
geese_data_1iso$correction_means = geese_data_day1$correction_means[,1]
geese_data_1iso$correction_sds = geese_data_day1$correction_sds[,1]
geese_data_1iso$concentration_means = geese_data_day1$concentration_means[,1]
```

Now load in with `simmr_load`. This automatically creates a 1D version of an iso-space plot:
```{r}
simmr_in_1D = geese_data_1iso %>% simmr_load
```

Now run simmr:

```{r}
simmr_out_1D = simmr_in_1D %>% simmr_mcmc
```

Plot output

```{r}
simmr_out_1D %>% plot(type = 'boxplot')
```

The other `summary`, `compare` and `plot` functions should all work the same.

## Setting up your own prior distributions

Most Bayesian models will work better when you include informative prior distributions on the dietary proportions. For arguments as to why you should use prior informative information (and where you could get it from), see [here](https://github.com/andrewcparnell/simms_course/blob/master/papers/Phillips_SIMMadvice_2014.pdf). `simmr` tries to make this easier for practitioners by including a specific function (`simmr_elicit') for including prior information.

We will use the `simmr_out` object created above. A reminder about the posterior values

```{r}
data("simmr_data_1")
simmr_out = simmr_data_1 %>% simmr_load %>% simmr_mcmc
simmr_out %>% summary(type = 'quantiles')
```

All these dietary proportions are very similar. We now suppose we had prior information (e.g. from stomach or fecal contents) that the mean dietary proportions were
```{r}
proportion_means = c(0.4,0.3,0.2,0.1)
```

...and proportion standard deviations:
```{r}
proportion_sds = c(0.08,0.02,0.01,0.02)
```

We put this into the `simmr_elicit` function as follows:
```{r}
prior = simmr_elicit(4, proportion_means,
                     proportion_sds)
```

This may take a few moments to run as the code tries to optimise the parameters of a prior distribution which matches these means and standard deviations, which sometimes may not be exactly possible. 

When finished, the model can be run using these prior distributions:
```{r}
simmr_out_informative = simmr_data_1 %>% 
  simmr_load %>% 
  simmr_mcmc(prior_control=list(means = prior$mean,
                                sd = prior$sd))
```

The new quantiles are:
```{r}
simmr_out_informative %>% summary(type = 'quantiles')
```

We can plot these priors with their posteriors
```{r}
simmr_out_informative %>% prior_viz
```

## Estimating trophic discrimination factors from feeding studies

The `simmr_mcmc_tdf` function runs a slightly different version of the main
`simmr_mcmc` function with the key difference that it estimates
the correction factors (i.e. trophic enrichment or trophic
discrimination factors; TEFs/TDFs) for a *known* set of dietary proportions. However, these dietary proportions can change in a single model run; see the example below.

The idea is that this code can be used for feeding studies where an
organism is fed a known proportional diet with a view to estimating
the correction factors to be used in a later stable isotope mixing
model when the organisms are observed in the field.

To run this model, we first load data into `simmr` as normal using `simmr_load`. Correction factors/TDFs should not be provided at this stage, though if they are they will be ignored during a run of `simmr_mcmc_tdf`.

```{r}
data('geese_data_day1')
geese_no_tdf = geese_data_day1
geese_no_tdf$correction_means = NULL
geese_no_tdf$correction_sds = NULL
simmr_tdf = geese_no_tdf %>% simmr_load
```

If we plot this data we end up with the mixtures being shifted slightly outside the mixing polygon. The job of this model is to move the values so that they match the known dietary proportions.

```{r}
plot(simmr_tdf)
```

We now run the model with some known dietary proportions. These dietary proportions should be given _for each individual_ in a matrix, even if they are the same for each individual. This example uses the same dietary proportions:
```{r}
p_known = matrix(c(0.68,0.09,0.1,0.12),
                 ncol = simmr_tdf$n_sources,
                 nrow = simmr_tdf$n_obs, 
                 byrow = TRUE)
```

We can then run the model with:
```{r, results = 'hide'}
simmr_tdf_out = simmr_tdf %>% simmr_mcmc_tdf(p = p_known)
```

Seeing as this is another Bayesian statistical model, we can look at the:
```{r}
simmr_tdf_out %>% summary(type='diagnostics')
```

... and then look at the predicted TDFs:
```{r}
simmr_tdf_out %>% summary(type='quantiles')
```

We can put the predicted TDFs back into a new model and check that the iso-space plot now is correct

```{r}
data('geese_data_day1')
geese_new_tdf = geese_data_day1
geese_new_tdf$correction_means = simmr_tdf_out$c_mean_est
geese_new_tdf$correction_sds = simmr_tdf_out$c_sd_est

simmr_tdf_2 = geese_new_tdf %>% simmr_load %>% simmr_mcmc
simmr_tdf_2 %>% plot(type = 'boxplot')
```

## Other advanced use of simmr

Whilst the above gives an introduction to the basic functions of simmr, the package is open source and all code is open to editing. The two objects created as part of this vignette `simmr_in` and `simmr_out` are R lists. They can be explored with e.g.

```{r,eval=FALSE}
str(simmr_in)
```

which will show their contents. The `simmr_out` object in particular allows for full access to all of the posterior dietary proportion samples. We can calculate for example the mean of source C dietary proportion:

```{r}
simmr_out$output$BUGSoutput$sims.list$p[,'Source C'] %>% mean
```

The backquotes around the 1 are required above because they specify which group (the first). We can thus find the probability that the posterior dietary proportion for Zostera is bigger than for Grass:

```{r}
mean(simmr_out$output$BUGSoutput$sims.list$p[,'Source C']>simmr_out$output$BUGSoutput$sims.list$p[,'Source B'])
```

With more detailed R knowledge, it is possible to create scripts which run multiple data sets in richer fashions than the default `simmr` functions. See the help file `help(simmr_mcmc)` for a full list of examples.

## Appendix - suggested reading

For the maths on the original SIAR model:  
Andrew C Parnell, Richard Inger, Stuart Bearhop, and Andrew L Jackson. Source partitioning using stable isotopes: coping with too much variation. PLoS ONE, 5(3):5, 2010.

For the geese data:  
Inger, R., Ruxton, G. D., Newton, J., Colhoun, K., Robinson, J. A., Jackson, A. L., & Bearhop, S. (2006). Temporal and intrapopulation variation in prey choice of wintering geese determined by stable isotope analysis. Journal of Animal Ecology, 75, 1190–1200.

For the maths behind the more advanced JAGS models:  
Andrew C. Parnell, Donald L. Phillips, Stuart Bearhop, Brice X. Semmens, Eric J. Ward, Jonathan W. Moore, Andrew L. Jackson, Jonathan Grey, David J. Kelly, and Richard Inger. Bayesian stable isotope mixing models. Environmetrics, 24(6):387–399, 2013.

For some good advice about mixing models:  
Donald L Phillips, Richard Inger, Stuart Bearhop, Andrew L Jackson, Jonathan W Moore, Andrew C Parnell, Brice X Semmens, and Eric J Ward. Best practices for use of stable isotope mixing models in food-web studies. Canadian Journal of Zoology, 92(10):823–835, 2014.









